- name: Set StrongCertificateBindingEnforcement
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Kdc
    name: StrongCertificateBindingEnforcement
    data: 2
    type: dword

- name: Turn on LDAP Logging
  ansible.windows.win_regedit:
    path: "{{ item.path }}"
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: "{{ item.type }}"
  with_items:
    - { path: 'HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostics', name: '15 Field Engineering', data: '5', type: 'dword' }
    - { path: 'HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters', name: 'Expensive Search Result Threshold', data: '1', type: 'dword'} 
    - { path: 'HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters', name: 'Inefficient Search Results Threshold', data: '1', type: 'dword' } 

- name: Increase Directory Service Log Size
  ansible.windows.win_regedit:
    path: 'HKLM:\SYSTEM\CurrentControlSet\Services\EventLog\Directory Service'
    name: MaxSize
    data: 104857600
    type: dword

- name: Ensure the target directory exists
  win_file:
    path: 'C:\Program Files\AIT'
    state: directory
- name: Copy Write-LDAPQueryLog.ps1
  ansible.builtin.win_copy:
    src: Write-LDAPQueryLog.ps1
    dest: 'C:\Program Files\AIT\Write-LDAPQueryLog.ps1'
- name: Create Directory in ProgramData AIT
  win_file:
    path: 'C:\ProgramData\AIT'
    state: directory

- name: Initial LDAP Log Parsing
  win_shell: |
    powershell.exe -ExecutionPolicy Bypass -File "C:\Program Files\AIT\Write-LDAPQueryLog.ps1"

- name: Create Scheduled Task for LDAPLogQueryParser
  community.windows.win_scheduled_task:
    name: LDAPLogQueryParser
    description: Parse Directory Service Logs
    actions:
      - path: powershell.exe
        arguments: -nop -exec bypass -File "C:\Program Files\AIT\Write-LDAPQueryLog.ps1"
        working_directory: C:\ProgramData\AIT
    triggers:
      - type: boot
        repetition:
          interval: PT1M
    username: SYSTEM
    run_level: highest